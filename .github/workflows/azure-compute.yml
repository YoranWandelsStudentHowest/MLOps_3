name: Azure ML Compute List

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  azure-ml:
    runs-on: ubuntu-latest
    env:
      GROUP: MLOps
      WORKSPACE: wandels-yoran-ml
      SUBSCRIPTION_ID: 19fe6b9f-c4f7-46ad-8824-f9af7431cbed
      LOCATION: westeurope

    steps:
      # Checkout repo (optional)
      - name: Checkout repository
        uses: actions/checkout@v3

      # Login to Azure via Service Principal
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Setup Python environment
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # Install Azure ML SDK
      - name: Install Azure ML SDK
        run: |
          pip install --upgrade pip
          pip install azure-ai-ml azure-identity

      # List Azure ML compute targets using Python SDK
      - name: List Azure ML Compute
        run: |
          python - <<EOF
          import os
          from azure.identity import DefaultAzureCredential
          from azure.ai.ml import MLClient

          subscription_id = os.environ["SUBSCRIPTION_ID"]
          resource_group = os.environ["GROUP"]
          workspace = os.environ["WORKSPACE"]

          credential = DefaultAzureCredential()
          client = MLClient(
              credential=credential,
              subscription_id=subscription_id,
              resource_group_name=resource_group,
              workspace_name=workspace
          )

          print("Compute targets in workspace:")
          for compute in client.compute.list():
              print(f"- {compute.name} ({compute.type})")
          EOF
