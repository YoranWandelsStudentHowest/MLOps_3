name: Kubernetes Test Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-k8s:
    runs-on: self-hosted
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Namespace aanmaken indien nodig
      - name: Ensure namespace exists
        shell: powershell
        run: |
          try {
              kubectl get namespace howest-fastapi | Out-Null
              Write-Host "Namespace 'howest-fastapi' already exists."
          } catch {
              kubectl create namespace howest-fastapi
              Write-Host "Namespace 'howest-fastapi' created."
          }

      # # 3. Optioneel: deploy random test Pod
      # - name: Deploy random Pod
      #   shell: powershell
      #   run: |
      #     $RandomID = -join ((48..57) + (97..122) | Get-Random -Count 6 | % {[char]$_})
      #     echo "ID=$RandomID" >> $env:GITHUB_ENV
      #     Write-Host "Generated Pod ID: $RandomID"
      #     $template = Get-Content k8s/pod-template.yml
      #     $podYaml = $template -replace '\$\{ID\}', $env:ID
      #     $podYaml | kubectl apply -f -
      #     Write-Host "Pod manifest applied with ID: $env:ID"

      # 4. Deployment + Service aanmaken
      - name: Apply Deployment
        shell: powershell
        run: kubectl apply -f k8s/nginx-deployment.yml

      - name: Apply Service
        shell: powershell
        run: kubectl apply -f k8s/nginx-service.yml

      # 5. Check pods
      - name: Check pod status
        shell: powershell
        run: kubectl get pods -n howest-fastapi

      # 6. Check service
      - name: Check service
        shell: powershell
        run: kubectl get svc -n howest-fastapi

      # 7. Rollout restart Deployment (voor updates)
      - name: Rollout restart deployment
        shell: powershell
        run: kubectl rollout restart deployment nginx-deployment -n howest-fastapi
