name: Kubernetes Test Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-k8s:
    runs-on: self-hosted
    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Namespace aanmaken indien nodig
      - name: Ensure namespace exists
        run: |
          kubectl get namespace howest-fastapi || kubectl create namespace howest-fastapi
        shell: powershell

      # 3. Pod (random) deployen - optioneel, als test
      - name: Deploy random Pod
        run: |
          $RandomID = -join ((48..57) + (97..122) | Get-Random -Count 6 | % {[char]$_})
          echo "ID=$RandomID" >> $env:GITHUB_ENV
          $template = Get-Content k8s/pod-template.yml
          $podYaml = $template -replace '\$\{ID\}', $env:ID
          $podYaml | kubectl apply -f -
          Write-Host "Pod manifest applied with ID: $env:ID"
        shell: powershell

      # 4. Deployment + Service aanmaken
      - name: Apply Deployment
        run: kubectl apply -f k8s/nginx-deployment.yml
        shell: powershell

      - name: Apply Service
        run: kubectl apply -f k8s/nginx-service.yml
        shell: powershell

      # 5. Check pods
      - name: Check pod status
        run: kubectl get pods -n howest-fastapi
        shell: powershell

      # 6. Check service
      - name: Check service
        run: kubectl get svc -n howest-fastapi
        shell: powershell

      # 7. Deployment rollout (indien update nodig)
      - name: Rollout restart deployment
        run: kubectl rollout restart deployment nginx-deployment -n howest-fastapi
        shell: powershell
